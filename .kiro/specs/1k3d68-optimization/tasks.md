# 1k3d68 模型精度优化任务列表

## 阶段 1: 基础重构

### 1. 添加模型类型检测
- [ ] 1.1 在 InsightFaceLandmark.h 中添加 ModelType 枚举
- [ ] 1.2 在 InsightFaceLandmark 类中添加 model_type 成员变量
- [ ] 1.3 实现 DetectModelType() 方法（基于文件名和输出形状）
- [ ] 1.4 在构造函数中调用模型类型检测
- [ ] 1.5 编写模型类型检测的单元测试

### 2. 重构 Extract 方法
- [ ] 2.1 将当前 Extract() 方法重命名为 ExtractSingle()
- [ ] 2.2 ExtractSingle() 添加 center_offset 参数支持偏移采样
- [ ] 2.3 创建新的 Extract() 方法作为主入口
- [ ] 2.4 确保重构后 2d106det 功能不受影响
- [ ] 2.5 编写重构后的回归测试

### 3. 添加配置管理结构
- [ ] 3.1 定义 CropConfig 结构体
- [ ] 3.2 定义 PreprocessConfig 结构体和 NormMode 枚举
- [ ] 3.3 定义 MultiSampleConfig 结构体
- [ ] 3.4 定义 ModelConfig 结构体整合所有配置
- [ ] 3.5 在 InsightFaceLandmark 类中添加配置管理成员
- [ ] 3.6 实现 InitializeConfigs() 方法初始化默认配置
- [ ] 3.7 实现 GetConfig() 方法根据模型类型返回配置

## 阶段 2: 裁剪和预处理优化

### 4. 实现裁剪比例独立化
- [ ] 4.1 修改裁剪逻辑使用 GetConfig().crop 配置
- [ ] 4.2 为 1k3d68 设置初始裁剪因子（1.6f）
- [ ] 4.3 为 2d106det 保持现有裁剪因子（1.75f）
- [ ] 4.4 验证 2d106det 裁剪行为未改变
- [ ] 4.5 编写裁剪独立性测试

### 5. 裁剪因子实验和优化
- [ ] 5.1 创建裁剪因子实验脚本 `tests/experiment_crop_factor.py`
- [ ] 5.2 测试裁剪因子范围 1.4f ~ 2.0f（步长 0.1f）
- [ ] 5.3 对每个因子计算与 2DFAN 的平均误差
- [ ] 5.4 记录实验结果到 JSON 文件
- [ ] 5.5 根据实验结果更新 1k3d68 的最优裁剪因子
- [ ] 5.6 验证优化后的精度提升

### 6. 实现预处理模式锁定
- [ ] 6.1 修改预处理逻辑支持 NormMode 配置
- [ ] 6.2 实现 ZERO_ONE 归一化模式
- [ ] 6.3 实现 MEAN_STD 归一化模式
- [ ] 6.4 保留 AUTO 模式用于 2d106det
- [ ] 6.5 编写预处理模式测试

### 7. 归一化模式实验和优化
- [ ] 7.1 创建归一化模式实验脚本 `tests/experiment_norm_mode.py`
- [ ] 7.2 测试 ZERO_ONE 模式的精度
- [ ] 7.3 测试 MEAN_STD 模式的精度
- [ ] 7.4 对比两种模式的稳定性
- [ ] 7.5 根据实验结果锁定 1k3d68 的最优归一化模式
- [ ] 7.6 验证优化后的精度提升

## 阶段 3: 多采样实现

### 8. 实现基础多采样功能
- [ ] 8.1 实现 ExtractWithMultiSample() 方法
- [ ] 8.2 生成采样偏移点（5点：中心+上下左右）
- [ ] 8.3 对每个偏移点调用 ExtractSingle()
- [ ] 8.4 实现多次采样结果的平均计算
- [ ] 8.5 添加多采样开关控制
- [ ] 8.6 编写多采样功能测试

### 9. 多采样性能优化
- [ ] 9.1 实现采样结果质量评估函数 EvaluateQuality()
- [ ] 9.2 实现自适应采样策略（高质量时跳过多采样）
- [ ] 9.3 优化内存使用（复用 tensor 内存）
- [ ] 9.4 测试多采样的性能开销
- [ ] 9.5 确保性能损失不超过 50%
- [ ] 9.6 编写性能基准测试

### 10. 扩展多采样配置
- [ ] 10.1* 支持 9 点采样（添加对角线方向）
- [ ] 10.2* 实现可配置的偏移像素数
- [ ] 10.3* 添加批处理推理支持（如果 ONNX Runtime 支持）
- [ ] 10.4* 编写扩展配置测试

## 阶段 4: 验证和测试

### 11. 实现输出一致性校验
- [ ] 11.1 定义 ValidationResult 结构体
- [ ] 11.2 实现 ValidateOutput() 方法
- [ ] 11.3 检查关键点数量（68点）
- [ ] 11.4 检查坐标有效性（NaN/Inf）
- [ ] 11.5 检查坐标范围（是否在合理区域内）
- [ ] 11.6 在 Extract() 中集成输出校验
- [ ] 11.7 添加异常情况日志记录
- [ ] 11.8 编写输出校验测试

### 12. 创建对比测试脚本
- [ ] 12.1 创建 `tests/test_1k3d68_optimization.py`
- [ ] 12.2 实现加载测试图片集功能
- [ ] 12.3 实现调用 1k3d68（优化前）提取关键点
- [ ] 12.4 实现调用 1k3d68（优化后）提取关键点
- [ ] 12.5 实现调用 2DFAN 提取关键点作为参考
- [ ] 12.6 实现误差指标计算（平均、标准差、最大、中位数）
- [ ] 12.7 生成对比报告（JSON 和文本格式）
- [ ] 12.8 验证精度提升达到目标（30%误差降低）

### 13. 创建可视化工具
- [ ] 13.1 创建 `tests/visualize_landmarks.py`
- [ ] 13.2 实现在图片上绘制关键点功能
- [ ] 13.3 使用不同颜色区分不同模型（2DFAN绿色、优化前蓝色、优化后红色）
- [ ] 13.4 标注误差较大的关键点
- [ ] 13.5 生成对比图并保存
- [ ] 13.6 实现批量可视化功能

### 14. 编写单元测试和回归测试
- [ ] 14.1 创建 `tests/test_1k3d68_regression.cpp`
- [ ] 14.2 编写模型类型检测测试
- [ ] 14.3 编写裁剪因子独立性测试
- [ ] 14.4 编写预处理模式测试
- [ ] 14.5 编写多采样逻辑测试
- [ ] 14.6 编写输出校验测试
- [ ] 14.7 编写 2d106det 向后兼容性测试
- [ ] 14.8 集成到 CI/CD 流程

## 阶段 5: 调优和文档

### 15. 参数调优和验证
- [ ] 15.1 运行完整的对比测试
- [ ] 15.2 分析各优化点的贡献度
- [ ] 15.3 微调裁剪因子和采样参数
- [ ] 15.4 验证精度目标达成（误差降低30%，接近2DFAN 50%以内）
- [ ] 15.5 验证性能目标达成（推理时间增加不超过50%）
- [ ] 15.6 记录最终参数和性能指标

### 16. 性能测试和优化
- [ ] 16.1 创建性能基准测试脚本
- [ ] 16.2 测试不同配置下的推理时间
- [ ] 16.3 分析性能瓶颈
- [ ] 16.4 优化关键路径代码
- [ ] 16.5 验证优化后性能满足要求
- [ ] 16.6 生成性能对比报告

### 17. 编写文档和注释
- [ ] 17.1 为所有新增代码添加详细注释
- [ ] 17.2 说明配置参数的含义和取值范围
- [ ] 17.3 记录实验结果和参数选择依据
- [ ] 17.4 编写用户文档（如何使用优化后的模型）
- [ ] 17.5 编写开发文档（架构设计和实验记录）
- [ ] 17.6 更新 README 和相关文档

### 18. 代码审查和清理
- [ ] 18.1 代码格式化和风格检查
- [ ] 18.2 移除调试代码和临时文件
- [ ] 18.3 检查内存泄漏和资源管理
- [ ] 18.4 代码审查和反馈修正
- [ ] 18.5 最终集成测试
- [ ] 18.6 准备发布和部署

## 验证检查清单

### 精度验证
- [ ] 1k3d68 平均误差降低至少 30%
- [ ] 1k3d68 与 2DFAN 误差差距缩小至 50% 以内
- [ ] 标准差降低至少 20%

### 性能验证
- [ ] 推理时间增加不超过 50%
- [ ] 内存使用无显著增加
- [ ] 多采样性能开销可接受

### 兼容性验证
- [ ] 2d106det 功能完全不受影响
- [ ] 接口保持向后兼容
- [ ] 现有代码无破坏性变更

### 测试覆盖
- [ ] 所有新增功能有单元测试
- [ ] 集成测试覆盖完整流程
- [ ] 回归测试确保无退化

## 注意事项

1. **2d106det 保护**: 每次修改后必须验证 2d106det 功能未受影响
2. **实验记录**: 所有实验结果必须记录到 JSON 文件，便于追溯
3. **性能监控**: 每个优化点都要测试性能影响
4. **代码隔离**: 1k3d68 和 2d106det 的配置和逻辑要清晰隔离
5. **渐进式优化**: 先实现基础功能，再进行性能优化
6. **充分测试**: 每个阶段完成后进行充分测试再进入下一阶段
