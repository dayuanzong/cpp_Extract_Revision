# 1k3d68 模型精度优化需求文档

## 项目概述

优化 1k3d68.onnx 人脸关键点检测模型的精度，使其接近或达到 2DFAN.onnx 的精度水平。2d106det.onnx 暂不优化，仅作为对比参考。

## 背景

### 当前问题
- 1k3d68.onnx 和 2d106det.onnx 的精确度不如 2DFAN.onnx
- 1k3d68 与 2d106det 共用同一条 InsightFaceLandmark 代码路径
- 当前裁剪比例是折中参数，影响 1k3d68 的精度

### 模型差异分析

| 特性 | 1k3d68 | 2DFAN | 2d106det |
|------|--------|-------|----------|
| 模型类型 | 坐标回归 | 热力图回归 | 坐标回归 |
| 输入尺寸 | 192×192 | 256×256 | 192×192 |
| 裁剪方式 | 固定比例系数 | scale=(w+h)/195.0 | 固定比例系数 |
| 归一化 | 自动选择 | 固定 1/255 | 自动选择 |
| 通道布局 | RGB, CHW | BGR→RGB, NHWC | RGB, CHW |
| 输出解码 | 68×2 或 68×3 | heatmap 最大值 | 106→68 映射 |
| 多采样 | 无 | 5点平均 | 无 |

## 用户故事

### 1. 作为开发者，我希望 1k3d68 有独立的裁剪参数
**验收标准**:
- 1k3d68 和 2d106det 的裁剪比例可以独立配置
- 不影响 2d106det 的现有行为
- 可以通过配置文件或代码参数调整

### 2. 作为开发者，我希望 1k3d68 使用最优的预处理模式
**验收标准**:
- 固定使用最匹配 1k3d68 的归一化模式
- 避免自动选择造成的精度波动
- 可以通过实验验证最优模式

### 3. 作为开发者，我希望 1k3d68 支持多采样平均
**验收标准**:
- 实现类似 2DFAN 的多采样策略（5点或可配置）
- 多采样可以开关控制
- 多采样不显著影响性能（可接受的性能损失）

### 4. 作为开发者，我希望能够验证优化效果
**验收标准**:
- 提供对比测试脚本，比较优化前后的精度
- 提供可视化工具，直观展示关键点差异
- 输出量化指标（如平均误差、最大误差等）

### 5. 作为开发者，我希望输出结果有自检机制
**验收标准**:
- 检测输出维度是否正确（68×2 或 68×3）
- 检测关键点坐标范围是否合理
- 异常情况下给出警告或回退

## 功能需求

### FR1: 裁剪比例独立化
**优先级**: 高

**描述**: 将 1k3d68 与 2d106det 的裁剪比例拆分，为 1k3d68 提供独立的裁剪参数。

**详细需求**:
1. 在 InsightFaceLandmark 类中添加模型特定的裁剪比例配置
2. 根据模型类型（1k3d68 vs 2d106det）选择对应的裁剪参数
3. 保持向后兼容，默认使用当前的裁剪比例

### FR2: 预处理模式锁定
**优先级**: 高

**描述**: 为 1k3d68 固定最优的归一化模式，避免自动选择。

**详细需求**:
1. 实验确定 1k3d68 的最优归一化模式（0..1 或 (x-127.5)/128）
2. 在代码中为 1k3d68 锁定该模式
3. 保留 2d106det 的现有行为

### FR3: 多采样平均
**优先级**: 中

**描述**: 为 1k3d68 实现多采样策略，提升稳定性。

**详细需求**:
1. 实现小范围多采样（参考 2DFAN 的 5 点采样）
2. 采样点包括：中心、上下左右微调
3. 对多次采样结果求平均
4. 提供开关控制是否启用多采样

### FR4: 输出一致性校验
**优先级**: 中

**描述**: 为 1k3d68 添加输出自检机制。

**详细需求**:
1. 检查输出维度（68×2 或 68×3）
2. 检查坐标范围（是否在图像范围内）
3. 检测异常点（如坐标为 NaN 或 Inf）
4. 异常情况下记录日志并可选回退

### FR5: 验证与可视化
**优先级**: 高

**描述**: 提供工具验证优化效果。

**详细需求**:
1. 创建对比测试脚本，比较 1k3d68 优化前后与 2DFAN 的精度
2. 实现可视化工具，绘制关键点对比图
3. 计算量化指标：
   - 平均欧氏距离误差
   - 最大误差
   - 标准差
4. 生成对比报告

## 非功能需求

### NFR1: 性能
- 多采样不应导致超过 2x 的性能损失
- 优化后的推理速度应保持在可接受范围内

### NFR2: 兼容性
- 不影响 2d106det 的现有功能
- 保持与现有代码的接口兼容
- 支持现有的模型文件格式

### NFR3: 可维护性
- 代码结构清晰，易于理解
- 配置参数集中管理
- 充分的注释和文档

### NFR4: 可测试性
- 每个优化点都有对应的测试用例
- 提供自动化测试脚本
- 支持回归测试

## 约束条件

1. **不修改 2d106det 流程**: 2d106det.onnx 仅作为对比参考，不进行优化
2. **保持接口兼容**: 优化不应破坏现有的 API 接口
3. **模型文件不变**: 不修改 .onnx 模型文件本身，仅优化推理流程
4. **代码位置**: 主要修改在 `core/src/InsightFaceLandmark.cpp` 和相关文件

## 成功标准

1. **精度提升**: 1k3d68 的平均误差降低至少 30%
2. **接近 2DFAN**: 1k3d68 与 2DFAN 的误差差距缩小至 50% 以内
3. **性能可接受**: 推理时间增加不超过 50%
4. **稳定性提升**: 标准差降低至少 20%
5. **测试覆盖**: 所有优化点都有对应的测试和验证

## 实施阶段

### 阶段 1: 分析与准备
- 梳理 1k3d68 当前的完整推理流程
- 确定最优的裁剪比例和归一化模式
- 设计多采样策略

### 阶段 2: 核心优化
- 实现裁剪比例独立化
- 锁定预处理模式
- 实现多采样平均

### 阶段 3: 验证与调优
- 创建验证脚本和可视化工具
- 对比测试优化效果
- 根据结果调整参数

### 阶段 4: 完善与文档
- 添加输出一致性校验
- 完善代码注释和文档
- 编写使用指南

## 风险与缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 优化后精度未达预期 | 高 | 中 | 多次实验，调整参数；保留回退机制 |
| 性能损失过大 | 中 | 中 | 优化多采样实现；提供开关控制 |
| 影响 2d106det | 高 | 低 | 充分测试；代码隔离 |
| 参数调优困难 | 中 | 中 | 提供自动化调参工具 |

## 参考资料

- 现有代码: `core/src/InsightFaceLandmark.cpp`
- 对比参考: `core/src/FAN.cpp` (2DFAN 实现)
- 测试脚本: `tests/test_face_proportion.py`
- 编程计划: `编程计划.md`
