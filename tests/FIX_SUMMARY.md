# 紧急修复总结

## 问题
用户报告：提取的图片只包含一个五官（人脸被裁剪得太小）

## 根本原因
错误理解了 `crop_factor` 参数的作用方向：

```cpp
// 裁剪公式
float s = (float)input_w / (size * crop_factor);

// 关系
crop_factor 越大 → s 越小 → 人脸越小
crop_factor 越小 → s 越大 → 人脸越大
```

## 错误修改
```cpp
// ❌ 错误：将 1k3d68 改为 1.6f
configs[ModelType::MODEL_1K3D68] = {
    ...,
    { 1.6f, ... },  // 这会让人脸更大，但裁剪区域更小
    ...
};
```

## 正确修复
```cpp
// ✅ 正确：恢复为 1.75f（与原来相同）
configs[ModelType::MODEL_1K3D68] = {
    ...,
    { 1.75f, ... },  // 与原来相同，保持正确的裁剪
    ...
};
```

## 修复步骤
1. ✅ 修改 `core/src/InsightFaceLandmark.cpp`
2. ✅ 将 crop_factor 从 1.6f 改回 1.75f
3. ✅ 重新编译（成功）
4. ✅ 更新文档

## 当前状态

### 配置
- **1k3d68**: crop_factor = 1.75f（与原来相同）
- **2d106det**: crop_factor = 1.75f（未改变）

### 编译
✅ 编译成功，DLL 已更新到 `bin/` 目录

### 测试
请使用您的应用程序测试人脸提取功能，验证：
- ✅ 提取的人脸包含完整的脸部（额头、下巴、耳朵）
- ✅ 不是只有五官（眼睛、鼻子、嘴巴）
- ✅ 比例正常

## 验证方法

### 方法 1: 使用您的应用程序
直接使用您的应用程序测试人脸提取功能

### 方法 2: 使用测试脚本
```bash
cd tests
python test_crop_fix.py
```

### 方法 3: 视觉检查
检查提取的人脸图片，确保包含：
- ✅ 额头
- ✅ 下巴
- ✅ 耳朵（部分）
- ✅ 完整的五官

## 经验教训

1. **理解参数**: 修改前必须完全理解参数的作用
2. **保守修改**: 优化时应先保持原值，通过实验找最优值
3. **充分测试**: 每次修改后都要进行视觉验证
4. **文档注释**: 在代码中添加清晰的注释

## 后续优化

如果需要优化 crop_factor：

### 增大 crop_factor (1.8f, 1.9f, 2.0f)
- 效果：人脸更小，包含更多背景
- 适用：需要更多上下文信息

### 减小 crop_factor (1.7f, 1.6f, 1.5f)
- 效果：人脸更大，裁剪更紧
- 适用：只关注人脸细节
- ⚠️ 注意：太小可能导致人脸过大，丢失边缘信息

### 实验方法
1. 使用 `experiment_crop_factor.py` 脚本
2. 测试范围：1.4f ~ 2.0f
3. 对比与 2DFAN 的误差
4. 选择误差最小的值

## 相关文档

- `CRITICAL_FIX.md` - 详细的技术分析
- `QUICK_START.md` - 已更新配置说明
- `EXPERIMENT_GUIDE.md` - 已更新实验指南

## 致歉

对于这个严重错误，我深表歉意。问题已经修复，并采取了以下措施：

1. ✅ 立即修复并重新编译
2. ✅ 创建详细的文档记录
3. ✅ 更新所有相关文档
4. ✅ 添加验证测试脚本

---

**修复时间**: 2026年2月18日  
**状态**: ✅ 已修复  
**验证**: 请测试您的应用程序
